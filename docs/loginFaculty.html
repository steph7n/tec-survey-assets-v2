<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Faculty Login – Tabgha School Survey</title>

  <!-- Shared CSS -->
  <link
    rel="stylesheet"
    href="style.css"
  />
</head>

<body>
  <!-- Top Bar -->
  <header class="app-bar">
    <img
      id="app-logo"
      alt="School Logo"
      class="app-bar__logo"
      src="school-logo.png"
    />
    <div id="app-title" class="app-bar__title"></div>
  </header>

  <main class="page-container">
    <section class="page-content">
      <div class="card card--centered login-card" id="login-card">
        <!-- Dynamic content inserted by JS -->
        <div id="login-content" class="login-dynamic"></div>
      </div>
    </section>
  </main>

  <script>
    (function () {
      const GAS_BASE_URL = "https://script.google.com/macros/s/AKfycbwovbgTtjg0C9fQiRc_9F31eW7QhQl6O8xQpjLQMsmwHxZk8Dg3Cpf9SgYX1mbfYLSr/exec";

      // ---------------------------
      // Utility helpers
      // ---------------------------

      const contentEl = document.getElementById("login-content");

      function render(html) {
        if (contentEl) contentEl.innerHTML = html;
      }

      function goto(path) {
        // Navigate to another static page in the same folder
        window.location.href = path;
      }

      function getCurrentUrl() {
        return window.location.href;
      }

      // Set dynamic top bar title
      (function setTopBarTitle() {
        const titleEl = document.getElementById("app-title");
        const currentYear = new Date().getFullYear();
        if (titleEl) {
          titleEl.textContent =
            "Tabgha Education Center School Survey " + currentYear;
        }
      })();

      // Initial loading state
      render(`
        <h1 class="card-title">Faculty Login</h1>
        <p class="form-label">Checking login status…</p>
      `);

      // ---------------------------
      // Login flow
      // ---------------------------

      function startGoogleLogin() {
        // Delegate the real OAuth flow to Apps Script.
        // The backend should:
        //  - Start Google OAuth
        //  - Restrict to @tabgha.education
        //  - Redirect back here after login
        const redirectUrl = encodeURIComponent(getCurrentUrl());
        const url =
          GAS_BASE_URL +
          "?action=facultyLoginStart" +
          "&redirect=" + redirectUrl;

        window.location.href = url;
      }

      function handleLoginResult(result) {
        if (!result || typeof result !== "object") {
          render(`<p class="form-error">Unexpected login response.</p>`);
          return;
        }

        // Expected result structure:
        // {
        //   loggedIn: true/false,
        //   email: "",
        //   validDomain: true/false,
        //   status: "superadmin" | "faculty" | "student" | "inactive"
        // }

        // Case 1: Not logged in at all
        if (!result.loggedIn) {
          render(`
            <h1 class="card-title">Faculty Login</h1>
            <p class="form-label">
              Please log in using your Tabgha Education Google account.
            </p>
            <button class="btn btn--primary btn--block" id="btn-login">
              Login with Google
            </button>
          `);
          const btn = document.getElementById("btn-login");
          if (btn) btn.onclick = startGoogleLogin;
          return;
        }

        // Case 2: Logged in but wrong domain
        if (!result.validDomain) {
          render(`
            <h1 class="card-title">Wrong Account</h1>
            <p class="form-error">
              You are logged in as <strong>${result.email}</strong><br>
              This account cannot access the survey.<br><br>
              Please log in with your <strong>@tabgha.education</strong> account.
            </p>
            <button class="btn btn--primary btn--block" id="btn-switch">
              Switch Account
            </button>
          `);
          const btn = document.getElementById("btn-switch");
          if (btn) btn.onclick = startGoogleLogin;
          return;
        }

        // Case 3: Domain valid → check status
        if (result.status === "superadmin") {
          goto("admin.html");
          return;
        }

        if (result.status === "faculty" || result.status === "student") {
          goto("surveyHome.html");
          return;
        }

        // Case 4: Valid domain but email not found → inactive page
        if (result.status === "inactive") {
          goto("surveyInactive.html");
          return;
        }

        // Fallback
        render(`<p class="form-error">Unknown login state.</p>`);
      }

      async function checkLoginStatus() {
        if (!GAS_BASE_URL || !GAS_BASE_URL.startsWith("http")) {
          // Local preview without backend configured
          render(`
            <h1 class="card-title">Faculty Login</h1>
            <p class="form-label">Local preview only.</p>
            <p class="text-hint">
              Configure <code>GAS_BASE_URL</code> in the script to enable live login.
            </p>
          `);
          return;
        }

        try {
          const response = await fetch(
            GAS_BASE_URL + "?action=checkFacultyLoginStatus",
            {
              method: "GET",
              credentials: "include",
              headers: {
                "Accept": "application/json",
              },
            }
          );

          if (!response.ok) {
            throw new Error("Network error: " + response.status);
          }

          const result = await response.json();
          handleLoginResult(result);
        } catch (error) {
          console.error("Login status check failed:", error);
          render(`
            <h1 class="card-title">Faculty Login</h1>
            <p class="form-error">
              Unable to contact the login server. Please try again later.
            </p>
          `);
        }
      }

      // Kick off login status check on load
      checkLoginStatus();
    })();
  </script>
</body>
</html>